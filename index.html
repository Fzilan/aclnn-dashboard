<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸš€ ACLNN Supported Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f3efe6;
      --card: #fffef9;
      --line: #d5ccbb;
      --text: #1d2120;
      --muted: #626a68;
      --accent: #005f73;
      --good: #2a9d8f;
      --warn: #ca6702;
      --bad: #bb3e03;
    }
    body { font-family: "IBM Plex Sans", sans-serif; color: var(--text); background: radial-gradient(circle at 5% 5%, #e4f2ef 0%, var(--bg) 38%, #f7f4eb 100%); }
    .mono { font-family: "JetBrains Mono", monospace; }
    .panel { background: var(--card); border: 1px solid var(--line); border-radius: 18px; }
    .pill { border-radius: 999px; padding: 2px 10px; font-size: 12px; font-weight: 600; }
    .fade-enter-active, .fade-leave-active { transition: opacity .2s; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    .slide-enter-active, .slide-leave-active { transition: transform .25s ease; }
    .slide-enter-from, .slide-leave-to { transform: translateX(100%); }
  </style>
</head>
<body>
<div id="app" class="min-h-screen px-4 py-6 md:px-8 md:py-8">
  <div class="mx-auto max-w-7xl space-y-5">
    <header class="panel p-6">
      <div class="flex flex-wrap items-end justify-between gap-4">
        <div>
          <h1 class="text-2xl font-bold md:text-3xl">ğŸš€ ACLNN Supported Dashboard</h1>
          <p class="mt-1 text-xs text-[color:var(--muted)]">
            Powered by repository:
            <a class="text-sky-700 underline hover:text-sky-800" href="https://github.com/Fzilan/aclnn-dashboard" target="_blank" rel="noopener noreferrer">
              github.com/Fzilan/aclnn-dashboard
            </a>
          </p>
          <p class="mt-2 text-sm text-[color:var(--muted)]">Datasource: CANN 8.5 + Torch-NPU master + MindSpore master</p>
        </div>
        <div class="text-sm text-[color:var(--muted)]">æœ€åæ›´æ–°: {{ fmtTime(metrics.last_update_time) }}</div>
      </div>
    </header>

    <section class="grid grid-cols-1 gap-4 md:grid-cols-5">
      <div class="panel p-4 md:col-span-2">
        <div class="text-xs font-semibold text-[color:var(--muted)]">åŒç«¯è¦†ç›–ç‡</div>
        <div class="mt-2 flex items-end gap-2">
          <div class="text-3xl font-bold text-[color:var(--accent)]">{{ metrics.both_coverage_rate || 0 }}%</div>
          <div class="text-sm text-[color:var(--muted)]">{{ metrics.both_supported || 0 }}/{{ metrics.total_ops || 0 }}</div>
        </div>
        <div class="mt-3 h-2 overflow-hidden rounded-full bg-stone-200">
          <div class="h-full rounded-full bg-[color:var(--accent)] transition-all duration-500" :style="{ width: (metrics.both_coverage_rate || 0) + '%' }"></div>
        </div>
      </div>
      <div class="panel p-4">
        <div class="text-xs font-semibold text-[color:var(--muted)]">Torch-NPU</div>
        <div class="mt-2 text-2xl font-bold text-[color:var(--good)]">{{ metrics.torch_supported || 0 }}</div>
        <div class="mt-1 text-xs text-[color:var(--muted)]">{{ metrics.torch_coverage_rate || 0 }}%</div>
      </div>
      <div class="panel p-4">
        <div class="text-xs font-semibold text-[color:var(--muted)]">MindSpore</div>
        <div class="mt-2 text-2xl font-bold text-cyan-700">{{ metrics.mindspore_supported || 0 }}</div>
        <div class="mt-1 text-xs text-[color:var(--muted)]">{{ metrics.mindspore_coverage_rate || 0 }}%</div>
      </div>
      <div class="panel p-4">
        <div class="text-xs font-semibold text-[color:var(--muted)]">Gap</div>
        <div class="mt-2 text-2xl font-bold text-[color:var(--bad)]">{{ metrics.unsupported || 0 }}</div>
        <div class="mt-1 text-xs text-[color:var(--muted)]">ä¸¤ç«¯éƒ½æœªæ¥å…¥</div>
      </div>
    </section>

    <section class="panel p-4">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <div class="text-sm font-semibold">7 å¤©æ¥å…¥é€Ÿåº¦</div>
          <div class="text-xs text-[color:var(--muted)]">å•ä½: è¦†ç›–ç‡ç™¾åˆ†ç‚¹/å¤© (pp/day)</div>
        </div>
        <div class="flex flex-wrap gap-2 text-xs">
          <span class="pill bg-emerald-100 text-emerald-700">Torch: {{ formatSpeed(metrics.torch_speed_pp_per_day_7d) }}</span>
          <span class="pill bg-sky-100 text-sky-700">MindSpore: {{ formatSpeed(metrics.mindspore_speed_pp_per_day_7d) }}</span>
        </div>
      </div>
      <div v-if="history7.length >= 2" class="mt-3">
        <svg viewBox="0 0 100 42" class="h-44 w-full rounded border border-stone-200 bg-white">
          <line x1="0" y1="8" x2="100" y2="8" stroke="#e7dfd0" stroke-width="0.4" />
          <line x1="0" y1="21" x2="100" y2="21" stroke="#e7dfd0" stroke-width="0.4" />
          <line x1="0" y1="34" x2="100" y2="34" stroke="#e7dfd0" stroke-width="0.4" />
          <polyline :points="torchLinePoints" fill="none" stroke="#059669" stroke-width="0.9" />
          <polyline :points="mindsporeLinePoints" fill="none" stroke="#0284c7" stroke-width="0.9" />
        </svg>
        <div class="mt-2 grid grid-cols-2 gap-2 text-xs md:grid-cols-7">
          <div v-for="item in history7" :key="item.date" class="rounded border border-stone-200 bg-white px-2 py-1">
            <div class="font-semibold">{{ shortDate(item.date) }}</div>
            <div class="text-emerald-700">T: {{ item.torch_coverage_rate }}%</div>
            <div class="text-sky-700">M: {{ item.mindspore_coverage_rate }}%</div>
          </div>
        </div>
      </div>
      <div v-else class="mt-3 text-xs text-[color:var(--muted)]">å†å²æ•°æ®ä¸è¶³ï¼Œè‡³å°‘éœ€è¦ 2 å¤©æ•°æ®ã€‚</div>
    </section>

    <section class="panel p-4">
      <div class="flex flex-wrap gap-3">
        <input v-model.trim="searchQuery" type="text" placeholder="æœç´¢ ACLNN API / è¯æ®å…³é”®å­—"
               class="w-full rounded-lg border border-stone-300 bg-white px-3 py-2 text-sm md:w-80">
        <select v-model="statusFilter" class="rounded-lg border border-stone-300 bg-white px-3 py-2 text-sm">
          <option value="all">å…¨éƒ¨çŠ¶æ€</option>
          <option value="both">åŒç«¯å·²æ¥å…¥</option>
          <option value="torch_only">ä»… Torch-NPU</option>
          <option value="mindspore_only">ä»… MindSpore</option>
          <option value="neither">åŒç«¯æœªæ¥å…¥</option>
        </select>
        <button @click="resetFilters" class="rounded-lg border border-stone-300 px-3 py-2 text-sm hover:bg-stone-100">é‡ç½®</button>
        <div class="ml-auto text-sm text-[color:var(--muted)]">æ˜¾ç¤º {{ filteredOperators.length }} / {{ operators.length }}</div>
      </div>
    </section>

    <section class="panel overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full text-left text-sm">
          <thead class="border-b border-[color:var(--line)] bg-stone-100/70 text-xs uppercase tracking-wide text-[color:var(--muted)]">
          <tr>
            <th class="px-4 py-3">ACLNN API</th>
            <th class="px-4 py-3">Torch-NPU</th>
            <th class="px-4 py-3">MindSpore</th>
            <th class="px-4 py-3">è·¯å¾„æ‘˜è¦</th>
          </tr>
          </thead>
          <tbody>
          <tr v-for="op in filteredOperators" :key="op.aclnn_api"
              class="cursor-pointer border-b border-stone-200/70 hover:bg-stone-50"
              @click="openDetails(op)">
            <td class="mono px-4 py-3 text-xs">{{ op.aclnn_api }}</td>
            <td class="px-4 py-3">
              <span :class="badgeClass(op.torch.supported)">{{ op.torch.status }}</span>
            </td>
            <td class="px-4 py-3">
              <span :class="badgeClass(op.mindspore.supported)">{{ op.mindspore.status }}</span>
              <span v-if="op.mindspore.pyboost" class="ml-2 pill bg-sky-100 text-sky-700">PyBoost</span>
              <span v-if="op.mindspore.kbk" class="ml-1 pill bg-indigo-100 text-indigo-700">KBK</span>
            </td>
            <td class="px-4 py-3 text-xs text-[color:var(--muted)]">
              {{ quickSummary(op) }}
            </td>
          </tr>
          <tr v-if="!filteredOperators.length">
            <td colspan="4" class="px-4 py-10 text-center text-sm text-[color:var(--muted)]">æ²¡æœ‰åŒ¹é…ç»“æœ</td>
          </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <Transition name="fade">
    <div v-if="activeOp" class="fixed inset-0 z-20 bg-black/40" @click="activeOp = null"></div>
  </Transition>
  <Transition name="slide">
    <aside v-if="activeOp" class="fixed right-0 top-0 z-30 h-full w-full max-w-2xl overflow-y-auto bg-[#fefcf5] shadow-2xl">
      <div class="flex items-center justify-between border-b border-stone-300 px-5 py-4">
        <div>
          <div class="mono text-lg font-semibold">{{ activeOp.aclnn_api }}</div>
          <div class="mt-1 text-xs text-[color:var(--muted)]">ç‚¹å‡»é®ç½©å¯å…³é—­</div>
        </div>
        <button class="rounded border border-stone-300 px-3 py-1 text-sm" @click="activeOp = null">å…³é—­</button>
      </div>
      <div class="space-y-5 p-5 text-sm">
        <section class="panel p-4">
          <div class="mb-2 font-semibold">Torch-NPU è¯æ®</div>
          <div class="space-y-2 text-xs">
            <div><span class="font-semibold">çŠ¶æ€:</span> {{ activeOp.torch.status }}</div>
            <div><span class="font-semibold">evidence:</span> {{ joinOrDash(activeOp.torch.evidence) }}</div>
            <div><span class="font-semibold">via ops:</span> {{ joinOrDash(activeOp.torch.via_ops) }}</div>
            <div><span class="font-semibold">direct match:</span> {{ joinOrDash(activeOp.torch.direct_match_ops) }}</div>
            <div><span class="font-semibold">C++ funcs:</span> {{ joinOrDash(activeOp.torch.cpp_funcs) }}</div>
            <div><span class="font-semibold">files:</span> {{ joinOrDash(activeOp.torch.cpp_files) }}</div>
            <div><span class="font-semibold">remarks:</span> {{ activeOp.torch.remarks || '-' }}</div>
          </div>
        </section>
        <section class="panel p-4">
          <div class="mb-2 font-semibold">MindSpore è¯æ®</div>
          <div class="space-y-2 text-xs">
            <div><span class="font-semibold">çŠ¶æ€:</span> {{ activeOp.mindspore.status }}</div>
            <div><span class="font-semibold">è·¯å¾„:</span> PyBoost={{ activeOp.mindspore.pyboost ? 'âœ…' : 'âœ–ï¸' }} / KBK={{ activeOp.mindspore.kbk ? 'âœ…' : 'âœ–ï¸' }}</div>
            <div><span class="font-semibold">evidence:</span> {{ joinOrDash(activeOp.mindspore.evidence) }}</div>
            <div><span class="font-semibold">via ops:</span> {{ joinOrDash(activeOp.mindspore.via_ops) }}</div>
            <div><span class="font-semibold">direct match:</span> {{ joinOrDash(activeOp.mindspore.direct_match_ops) }}</div>
            <div><span class="font-semibold">C++ funcs:</span> {{ joinOrDash(activeOp.mindspore.cpp_funcs) }}</div>
            <div><span class="font-semibold">kernel files:</span> {{ joinOrDash(activeOp.mindspore.kernel_mod_files) }}</div>
            <div><span class="font-semibold">pyboost files:</span> {{ joinOrDash(activeOp.mindspore.pyboost_files) }}</div>
            <div><span class="font-semibold">custom dispatch:</span> {{ joinOrDash(activeOp.mindspore.custom_dispatch_names) }}</div>
            <div><span class="font-semibold">remarks:</span> {{ activeOp.mindspore.remarks || '-' }}</div>
          </div>
        </section>
      </div>
    </aside>
  </Transition>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      metrics: {},
      operators: [],
      historyDaily: [],
      searchQuery: "",
      statusFilter: "all",
      activeOp: null,
      loadError: ""
    };
  },
  computed: {
    history7() {
      return this.historyDaily.slice(-7);
    },
    chartBounds() {
      const vals = [];
      for (const row of this.history7) {
        vals.push(Number(row.torch_coverage_rate || 0));
        vals.push(Number(row.mindspore_coverage_rate || 0));
      }
      if (!vals.length) return { min: 0, max: 100 };
      const rawMin = Math.min(...vals);
      const rawMax = Math.max(...vals);
      const min = Math.max(0, Math.floor(rawMin - 1));
      const max = Math.min(100, Math.ceil(rawMax + 1));
      return { min, max: max <= min ? min + 1 : max };
    },
    torchLinePoints() {
      return this.buildLinePoints("torch_coverage_rate");
    },
    mindsporeLinePoints() {
      return this.buildLinePoints("mindspore_coverage_rate");
    },
    filteredOperators() {
      const q = this.searchQuery.toLowerCase();
      return this.operators.filter((op) => {
        const matchStatus = this.statusFilter === "all" || op.coverage_status === this.statusFilter;
        if (!matchStatus) return false;
        if (!q) return true;
        const pool = [
          op.aclnn_api,
          ...(op.torch.via_ops || []),
          ...(op.torch.evidence || []),
          ...(op.mindspore.via_ops || []),
          ...(op.mindspore.evidence || [])
        ].join(" ").toLowerCase();
        return pool.includes(q);
      });
    }
  },
  methods: {
    async loadData() {
      const res = await fetch("./data.json", { cache: "no-store" });
      if (!res.ok) throw new Error(`åŠ è½½ data.json å¤±è´¥: HTTP ${res.status}`);
      const data = await res.json();
      this.metrics = data.metrics || {};
      this.historyDaily = (data.history && data.history.daily_coverage) ? data.history.daily_coverage : [];
      this.operators = (data.operators || []).map((op) => ({
        ...op,
        torch: {
          ...op.torch,
          status: op.torch && op.torch.supported ? "supported" : "unsupported"
        },
        mindspore: {
          ...op.mindspore,
          status: op.mindspore && op.mindspore.supported ? "supported" : "unsupported"
        }
      }));
    },
    fmtTime(raw) {
      if (!raw) return "-";
      const dt = new Date(raw);
      return Number.isNaN(dt.getTime()) ? raw : dt.toLocaleString("zh-CN", { hour12: false });
    },
    joinOrDash(list) {
      return list && list.length ? list.join("; ") : "-";
    },
    badgeClass(ok) {
      return `pill ${ok ? "bg-emerald-100 text-emerald-700" : "bg-rose-100 text-rose-700"}`;
    },
    buildLinePoints(key) {
      const arr = this.history7;
      if (!arr.length) return "";
      const min = this.chartBounds.min;
      const max = this.chartBounds.max;
      const span = Math.max(1, max - min);
      return arr.map((row, idx) => {
        const x = arr.length === 1 ? 0 : (idx / (arr.length - 1)) * 100;
        const value = Number(row[key] || 0);
        const y = 36 - (((value - min) / span) * 30);
        return `${x.toFixed(2)},${y.toFixed(2)}`;
      }).join(" ");
    },
    formatSpeed(value) {
      const v = Number(value || 0);
      return `${v >= 0 ? "+" : ""}${v.toFixed(3)} pp/day`;
    },
    shortDate(dateStr) {
      if (!dateStr) return "-";
      const dt = new Date(`${dateStr}T00:00:00Z`);
      if (Number.isNaN(dt.getTime())) return dateStr;
      return dt.toLocaleDateString("zh-CN", { month: "2-digit", day: "2-digit" });
    },
    quickSummary(op) {
      const t = (op.torch.via_ops || []).length;
      const m = (op.mindspore.via_ops || []).length;
      return `Torch via ${t} / MS via ${m}`;
    },
    resetFilters() {
      this.searchQuery = "";
      this.statusFilter = "all";
    },
    openDetails(op) {
      this.activeOp = op;
    }
  },
  async mounted() {
    try {
      await this.loadData();
    } catch (err) {
      this.loadError = String(err);
      console.error(err);
      alert(this.loadError);
    }
  }
}).mount("#app");
</script>
</body>
</html>
